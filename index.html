<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Secure | mscmkn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --wa-bg: #0b141a; --wa-sidebar: #111b21; --wa-header: #202c33; --wa-active: #2a3942; --wa-msg-in: #202c33; --wa-msg-out: #005c4b; }
        body { background-color: #0b141a; color: #e9edef; font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; }
        .chat-wallpaper { background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-color: #0b141a; background-blend-mode: overlay; }
        .msg-shadow { shadow-sm: 0 1px 0.5px rgba(0,0,0,0.13); }
    </style>
</head>
<body class="flex">

    <aside class="w-1/3 min-w-[300px] max-w-[450px] bg-[--wa-sidebar] border-r border-[#222d34] flex flex-col h-full hidden md:flex">
        <header class="bg-[--wa-header] h-[60px] p-3 flex justify-between items-center">
            <div class="w-10 h-10 bg-slate-600 rounded-full flex items-center justify-center font-bold">U</div>
            <div class="flex gap-5 text-[#aebac1] text-lg">
                <i class="fas fa-circle-notch cursor-pointer"></i>
                <i class="fas fa-comment-alt cursor-pointer"></i>
                <i class="fas fa-ellipsis-v cursor-pointer"></i>
            </div>
        </header>

        <div class="p-2 bg-[--wa-sidebar]">
            <div class="bg-[--wa-header] flex items-center px-4 py-1.5 rounded-lg">
                <i class="fas fa-search text-xs text-[#8696a0] mr-4"></i>
                <input type="text" placeholder="Search or start new chat" class="bg-transparent text-sm w-full outline-none placeholder:text-[#8696a0]">
            </div>
        </div>

        <div class="flex-1 overflow-y-auto">
            <div class="bg-[--wa-active] flex items-center p-3 gap-3 cursor-pointer border-b border-[#222d34]">
                <div class="w-12 h-12 bg-indigo-700 rounded-full flex items-center justify-center text-white font-bold">M</div>
                <div class="flex-1 border-b border-[#222d34] pb-3">
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-[16px]">mscmkn (Secure)</span>
                        <span class="text-[12px] text-[#8696a0]">Online</span>
                    </div>
                    <div class="text-[13px] text-[#8696a0] truncate">E2EE Private Channel</div>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full">
        <header class="bg-[--wa-header] h-[60px] p-3 px-4 flex justify-between items-center shadow-md">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-indigo-700 rounded-full flex items-center justify-center text-white font-bold">M</div>
                <div>
                    <h2 class="font-semibold text-sm">mscmkn</h2>
                    <p class="text-[11px] text-[#8696a0]">click here for contact info</p>
                </div>
            </div>
            
            <div class="flex flex-col items-end gap-1">
                <input id="keyInput" type="password" placeholder="Encryption Key" class="bg-[#2a3942] text-[10px] p-1 px-2 rounded outline-none border border-yellow-800 focus:border-green-500 w-32">
                <input id="userInput" type="text" placeholder="Your Name" class="bg-[#2a3942] text-[10px] p-1 px-2 rounded outline-none w-32">
            </div>
        </header>

        <div id="chatBox" class="flex-1 overflow-y-auto chat-wallpaper p-6 flex flex-col gap-2">
            <div class="mx-auto bg-[#182229] border border-yellow-900/30 text-[#ffd279] text-[11px] py-1.5 px-4 rounded-lg shadow uppercase tracking-tight text-center max-w-[85%]">
                <i class="fas fa-lock mr-2"></i> Messages are end-to-end encrypted. No one outside of this chat, not even WhatsApp, can read them.
            </div>
        </div>

        <footer class="bg-[--wa-header] p-2 flex items-center gap-3">
            <div class="flex gap-4 px-2 text-[#8696a0] text-xl">
                <i class="far fa-smile cursor-pointer"></i>
                <i class="fas fa-plus cursor-pointer"></i>
            </div>
            <input id="msgInput" type="text" placeholder="Type a message" class="flex-1 bg-[--wa-active] py-2.5 px-5 rounded-lg outline-none text-sm">
            <button onclick="sendMessage()" class="w-10 h-10 flex items-center justify-center text-[#8696a0] hover:text-white transition-colors">
                <i class="fas fa-paper-plane text-lg"></i>
            </button>
        </footer>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCDIpEsJtVWkhE7_EtciRiULDS27FK1Xmk",
            authDomain: "private--chat-4f6c4.firebaseapp.com",
            projectId: "private--chat-4f6c4",
            storageBucket: "private--chat-4f6c4.firebasestorage.app",
            messagingSenderId: "754573371275",
            appId: "1:754573371275:web:6dee9b502ef3ededbc718e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const messagesCol = collection(db, "chats_secure");

        async function getCryptoKey(passphrase) {
            const enc = new TextEncoder();
            const material = await crypto.subtle.importKey("raw", enc.encode(passphrase), "PBKDF2", false, ["deriveKey"]);
            return crypto.subtle.deriveKey(
                { name: "PBKDF2", salt: enc.encode("mscmkn-wa-v1"), iterations: 100000, hash: "SHA-256" },
                material, { name: "AES-GCM", length: 256 }, false, ["encrypt", "decrypt"]
            );
        }

        window.sendMessage = async () => {
            const text = document.getElementById('msgInput').value;
            const pass = document.getElementById('keyInput').value;
            const sender = document.getElementById('userInput').value || "Guest";
            if (!text || !pass) return;

            const key = await getCryptoKey(pass);
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const ciphertext = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, key, new TextEncoder().encode(text));

            await addDoc(messagesCol, {
                sender,
                payload: btoa(String.fromCharCode(...new Uint8Array(ciphertext))),
                iv: btoa(String.fromCharCode(...iv)),
                timestamp: serverTimestamp()
            });
            document.getElementById('msgInput').value = "";
        };

        onSnapshot(query(messagesCol, orderBy("timestamp", "asc")), (snap) => {
            const box = document.getElementById('chatBox');
            box.innerHTML = '<div class="mx-auto bg-[#182229] border border-yellow-900/30 text-[#ffd279] text-[11px] py-1.5 px-4 rounded-lg mb-4 text-center max-w-[85%]"><i class="fas fa-lock mr-2"></i> Messages are end-to-end encrypted.</div>';
            
            snap.forEach(async d => {
                const data = d.data();
                const pass = document.getElementById('keyInput').value;
                let display = "●●●●●●●";
                
                if (pass) {
                    try {
                        const key = await getCryptoKey(pass);
                        const dec = await crypto.subtle.decrypt(
                            { name: "AES-GCM", iv: new Uint8Array(atob(data.iv).split("").map(c => c.charCodeAt(0))) },
                            key, new Uint8Array(atob(data.payload).split("").map(c => c.charCodeAt(0)))
                        );
                        display = new TextDecoder().decode(dec);
                    } catch(e) { display = "--- Locked ---"; }
                }

                const isMe = data.sender.toLowerCase() === "mscmkn";
                const time = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : "...";
                
                const html = `
                    <div class="max-w-[75%] min-w-[80px] p-1.5 px-2.5 shadow rounded-lg relative mb-1 ${isMe ? 'bg-[--wa-msg-out] self-end' : 'bg-[--wa-msg-in] self-start'}">
                        <div class="text-[11px] font-bold ${isMe ? 'text-green-300' : 'text-blue-400'}">${data.sender}</div>
                        <div class="text-[14px] leading-tight pb-3 pr-8">${display}</div>
                        <div class="text-[10px] text-[#8696a0] absolute bottom-1 right-2 flex items-center gap-1">
                            ${time} ${isMe ? '<i class="fas fa-check-double text-blue-400"></i>' : ''}
                        </div>
                    </div>`;
                box.innerHTML += html;
                box.scrollTop = box.scrollHeight;
            });
        });
    </script>
</body>
</html>
